# 엘라스틱서치를 구성하는 개념

## 기본 용어
### 엘라스틱서치의 데이터는 인덱스, 타입, 문서, 필드 구조로 구성된다.
- 인덱스 (Index)
    - 데이터 저장 공간
    - 하나의 인덱스는 하나의 타입만 가지며 하나의 물리적인 노드에 여러 개의 논리적인 인덱스를 생성할 수 있다.
    - 검색 시 인덱스 이름으로 문서 데이터를 검색하며, 여러 개의 인덱스를 동시에 검색하는 것도 가능하다.
    - 분산 환경으로 구성하면 하나의 인덱스가 여러 노드에 분산 저장되어 관리되며 분산 처리에 다른 여러 이점을 누릴 수 있다.
    - 인덱스 생성 시 기본적으로 5개의 프라이머리(Primary) 샤드와 1개의 레플리카(Replica) 샤드 세트를 생성하며 각각의 샤드 수는 인덱스를 생성할 때 옵션을 이용해 변경할 수 있다.
    - 인덱스의 이름은 모두 소문자여야 한다.
    - 추가, 수정, 삭제, 검색은 RESTful API로 수행할 수 있다.
    - 인덱스가 없는 상태에서 데이터가 추가된다면 데이터를 이용해 인덱스가 자동으로 생성된다.
- 샤드 (Shard)
    - 색인된 문서는 하나의 인덱스에 담기고, 인덱스 내부에 색인된 데이터는 물리적인 공간에 여러 개의 파티션으로 나뉘어 구성되는데, 이 파티션을 샤드라고 부른다.
    - 엘라스틱서치는 다수의 샤드로 문서를 분산 저장하고 있어 데이터 손실 위험을 최소화할 수 있다.
- 타입 (Type)
    - 인덱스의 논리적 구조를 의미하며, 인덱스 속성에 따라 분류하기도 한다.
    - 엘라스틱서치 6.0 버전 이하에서는 하나의 인덱스에 여러 타입을 설정 가능했지만 6.1 버전부터는 인덱스당 하나의 타입만 사용할 수 있다.
- 문서 (Document)
    - 엘라스틱서치에서 데이터가 저장되는 최소 단위
    - 기본적으로 JSON 포맷으로 데이터가 저장된다.
    - 하나의 문서는 다수의 필드로 구성돼 있는데 각 필드는 데이터의 형태에 따라 용도에 맞는 데이터 타입(Data Type)을 정의해야 한다.
    - 중첩 구조를 지원하기 때문에 이를 이용해 문서 안에 문서를 지정하는 것도 가능하다.
- 필드 (Field)
    - 문서를 구성하기 위한 속성
    - 하나의 필드는 목적에 따라 다수의 데이터 타입을 가질 수 있다. (매칭 검색을 하거나 초성을 이용한 검색이 모두 지원되도록 keyword, text 타입 생성)
- 매핑 (Mapping)
    - 문서의 필드와 필드의 속성을 정의하고 그에 따른 색인 방법을 정의하는 프로세스
    - 여러 가지 데이터 타입을 지정할 수 있지만 필드명은 중복해서 사용할 수 없다.

## 노드의 종류
### 클러스터
- 물리적인 노드 인스턴스들의 모임
- 모든 노드의 검색과 색인 작업을 관장하는 논리적인 개념
- 분산 처리를 위해서는 다양한 형태의 노드들을 조합해서 클러스터를 구성해야 한다
- 기본적으로 마스터 노드가 전체적인 클러스터를 관리하고 데이터 노드가 실제 데이터를 관리한다.
### 노드의 종류
- 마스터 노드 (Master Node)
    - 인덱스를 생성, 삭제하는 등 클러스터와 관련된 전반적인 작업을 담당
    - 네트워크 속도가 빠르고 지연이 없는 노드를 마스터 노드로 선정해야 한다.
    - 다수의 노드를 마스터 노드로 설정할 수 있지만 결과적으로 하나의 노드만이 마스터 노드로 선출되어 동작한다.
    ``` yml
    # elasticsearch.yml 설정

    node.master: true
    node.data: false
    node.ingest: false
    search.remote.connect: false
    ```
- 데이터 노드 (Data Node)
    - 문서가 실제 저장되는 노드
    - 데이터가 실제로 분산 저장되는 물리적인 공간인 샤드가 배치되는 노드이기도 하다.
    - 색인 작업은 CPU, 메모리, 스토리지 같은 컴퓨팅 리소스를 많이 소모하기 때문에 리소스 모니터링이 필요하다.
    - 데이터 노드는 가능한 한 마스터 노드와 분리해서 구성하는 게 좋다.
    ```yml
    # elasticsearch.yml 설정

    node.master: false
    node.data: true
    node.ingest: false
    search.remote.connect: false
    ```
- 코디네이팅 노드 (Coordingating Node)
    - 데이터 노드, 마스터 노드, 인제스트 노드의 역할을 하지 않고, 들어온 요청을 단순히 라운드로빈 방식으로 분산시켜 주는 노드
    ```yml
    # elasticsearch.yml 설정

    node.master: false
    node.data: false
    node.ingest: false
    search.remote.cnnect: false
    ```
- 인제스트 노드 (Ingest Node)
    - 색인에 앞서 데이터를 전처리하기 위한 노드
    - 데이터 포맷을 변경하기 위해 스크립트로 전처리 파이프라인을 구성하고 실행할 수 있다.
    ```yml
    # elasticsearch.yml 설정

    node.master: false
    node.data: false
    node.ingest: true
    search.remote.connect: false
    ```

## 클러스터, 노드, 샤드
- 하나의 엘라스틱서치 클러스터에 여러개의 물리적 노드가 존재할 수 있다.
- 엘라스틱서치 클러스터는 인덱스의 문서를 조회할 때 마스터 노드를 통해 모든 노드를 조회해서 각 데이터를 취합한 후 결과를 하나로 합쳐서 제공한다.
- 여러 개의 클러스터를 연결해서 구성할 수도 있으며, 이때는 클러스터의 이름으로 각각을 구분한다.
- 클러스터에 있는 노드는 실시간으로 추가, 제거가 가능하기 때문에 가용성이나 확장성 측면에서 매우 유연하다.
```json
# 프라이머리 샤드 3개, 레플리카 샤드 1세트로 구성한 예시

{
    "settings": {
        "index": {
            "number_of_shards": 3,
            "number_of_replicas": 0
        }
    }
}
```